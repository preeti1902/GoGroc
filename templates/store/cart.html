{% extends "base/base.html" %}
{% block head %}
<link rel="stylesheet" href="/media/css/cart.css" />
{% endblock head %}
{% block main %}
<main class="cart-main">
  <div class="cart-container">
    <div class="form-section">
      <h2>Delivery Address</h2>
      <ul class="existing-addresses">
        <li>
          <h3>Select Existing Address</h3>
          <ul class="address-options">
            {% for address in addresses %}
            <li class="address-card">
              <input type="radio" name="address" id="home-address" />
              <label for="home-address" class="address-label">
                <div class="address-nickname">HOME</div>
                <div class="address-details">
                  <strong>{{address.first_name}} {{address.last_name}}</strong><br />
                  +91 {{address.mobile}}<br />
                  {{address.address}}<br />
                  {{address.city}} {{address.state}} - {{address.zip_code}}
                </div>
              </label>
            </li>
            {% endfor %}
          </ul>
          <button class="add-new-address-btn" onclick="toggleAddressForm()">
            + Add New Address
          </button>
        </li>
      </ul>

      <!-- Add New Address Form -->
      <form method="POST" action="{% url 'addAddress' %}" class="add-address-form" id="add-address-form"
        style="display: none">
        {% csrf_token %}
        <h3>Add New Address</h3>
        <div class="delivery-details">
          <div class="flex-row">
            <div class="flex-col">
              <label>First Name</label>
              <input type="text" name="first_name" placeholder="Enter first name" required />
            </div>
            <div class="flex-col">
              <label>Last Name</label>
              <input type="text" name="last_name" placeholder="Enter last name" required />
            </div>
            <div class="flex-col">
              <label>Contact Number</label>
              <input type="text" name="mobile" placeholder="Enter contact number" required />
            </div>
          </div>

          <div class="flex-row">
            <div class="flex-col">
              <label>Address</label>
              <input type="text" name="full_address" />
            </div>
          </div>

          <div class="flex-row">
            <div class="flex-col">
              <label>City</label>
              <input type="text" name="city" />
            </div>
            <div class="flex-col">
              <label>State</label>
              <input type="text" name="state" />
            </div>
            <div class="flex-col">
              <label>Pincode</label>
              <input type="text" name="zip_code" placeholder="Enter pincode" />
            </div>
          </div>

          <input type="hidden" name="address_type" id="address_type" value="home" />

          <label>Choose nickname for this address:</label>
          <div class="nickname-buttons">
            <button type="button" class="nickname-btn active" onclick="selectNickname(this)">
              HOME
            </button>
            <button type="button" class="nickname-btn" onclick="selectNickname(this)">
              OFFICE
            </button>
            <button type="button" class="nickname-btn" onclick="selectNickname(this)">
              OTHER
            </button>
          </div>

          <div class="form-buttons">
            <button type="button" class="btn cancel-btn" onclick="toggleAddressForm()">
              CANCEL
            </button>
            <button type="submit" class="btn save-btn">SAVE ADDRESS</button>
          </div>
        </div>
      </form>

      <!-- Delivery Options -->
      <div class="collapsible">
        <div class="dropdown" onclick="toggleDropdown('delivery-options')">
          <strong>Delivery Options</strong>
        </div>
        <div class="options" id="delivery-options">
          <label><input type="radio" name="delivery" checked> Free Delivery</label>
        </div>
      </div>
    </div>

    <div class="summary-wrapper">
      <div class="summary-section">
        <h3>Order Summary</h3>
        <form method="POST" action="{% url 'cartPage' %}" class="voucher-box p-3 rounded shadow-sm"
          style="background-color: #f9f9f9;">
          {% include "base/alert.html" %}
          {% csrf_token %}
          {% if cart.coupon %}
          <div class="mb-3">
            <p class="mb-1 text-success fw-semibold">
              <i class="bi bi-check-circle-fill"></i> Applied Coupon: {{ cart.coupon.coupon_code }}
              <span class="badge bg-success text-white"></span><br />
            </p>
            <p class="mb-2">Discount: Rs {{ cart.coupon.discount_price }}</p><br />
            <button name="remove_coupon" value="1" type="submit" class="btn btn-outline-danger w-100">
              <i class="bi bi-x-circle"></i> Remove Coupon
            </button>
          </div>
          {% else %}
          <div class="mb-3">
            <label for="coupon" class="form-label fw-semibold">Select a Coupon</label><br />
            <select name="coupon" id="coupon" class="form-select">
              <option disabled selected>Select a Coupon</option>
              {% for coupon in coupons %}
              <option value="{{ coupon.coupon_code }}">{{ coupon.coupon_code }} â€” Rs {{ coupon.discount_price }}
              </option>
              {% endfor %}
            </select>
          </div>
          <br />
          <button type="submit" class="btn w-100">
            <i class="bi bi-tag-fill"></i> Apply Coupon
          </button>
          {% endif %}
        </form>


        <div class="summary-line">
          <span>Basket Value</span>
          <span>Rs {{ cart.get_cart_total_without_discount }}</span>
        </div>

        <div class="summary-line">
          <span>Delivery Charge</span>
          <span><del>Rs 50</del> <strong>Free</strong></span>
        </div>

        <div class="summary-line">
          <span>Voucher Discount</span>
          {% if cart.coupon %}
          <span>- Rs {{ cart.get_discount_price }}</span>
          {% else %}
          <span>-</span>
          {% endif %}
        </div>

        <div class="summary-line total">
          <span>Total Amount Payable</span>
          <span>Rs {{ cart.get_cart_total }}</span>
        </div>

        <p class="savings">
          {% if cart.coupon %}
          Your Total Savings Rs {{ cart.get_discount_price }}
          {% endif %}
        </p>

        <button id="rzp-button1" class="checkout-btn">Pay Now</button>
      </div>
    </div>

  </div>
</main>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
  var options = {
    "key": "rzp_test_171e6d7TSvS6aZ",
    "amount": "{{payment.amount}}",
    "currency": "INR",
    "name": "GoGroc",
    "description": "Purchase Transaction",
    "order_id": "{{payment.id}}",
    "handler": function (response) {
      window.location.href = `http://127.0.0.1:8000/store/success/?razorpay_order_id=${response.razorpay_order_id}`
    },
    "theme": {
      "color": "#3399cc"
    }
  };
  var rzp1 = new Razorpay(options);
  rzp1.on('payment.failed', function (response) {
    alert(response.error.code);
    alert(response.error.description);
    alert(response.error.source);
    alert(response.error.step);
    alert(response.error.reason);
    alert(response.error.metadata.order_id);
    alert(response.error.metadata.payment_id);
  });
  document.getElementById('rzp-button1').onclick = function (e) {
    rzp1.open();
    e.preventDefault();
  }
</script>
<script>
  function toggleDropdown(id) {
    const options = document.getElementById(id);
    options.classList.toggle("show");
  }

  function toggleAddressForm() {
    const form = document.getElementById("add-address-form");
    const isVisible = form.style.display !== "none";
    form.style.display = isVisible ? "none" : "block";
  }

  function selectNickname(button) {
    const buttons = document.querySelectorAll(".nickname-btn");
    buttons.forEach((btn) => btn.classList.remove("active"));

    // Add active class to clicked button
    button.classList.add("active");
  }

  function selectNickname(button) {
    document
      .querySelectorAll(".nickname-btn")
      .forEach((btn) => btn.classList.remove("active"));
    button.classList.add("active");
    document.getElementById("address_type").value =
      button.innerText.toLowerCase();
  }
</script>

{% endblock main %}