{% extends "base/base.html" %}

{% block head %}
<link rel="stylesheet" href="/media/css/cart.css" />
{% endblock head %}

{% block main %}
<main class="cart-main">
    <div class="cart-items-section">
                <h2>Your Cart Items</h2>
                <div class="cart-items-container">
                    <!-- Sample cart items - these would come from backend -->
                    <div class="cart-item">
                        <div class="item-image">
                            <img src="/media/images/product1.jpg" alt="Fresh Apples" onerror="this.style.background='#f0f0f0'; this.innerHTML='IMG';">
                        </div>
                        <div class="item-details">
                            <h4 class="item-name">Fresh Red Apples</h4>
                            <p class="item-description">Premium quality apples - 1kg pack</p>
                            <div class="item-price-quantity">
                                <span class="item-price">₹120</span>
                                <div class="quantity-controls">
                                    <button class="qty-btn" onclick="updateQuantity(1, -1)">-</button>
                                    <span class="quantity" id="qty-1">2</span>
                                    <button class="qty-btn" onclick="updateQuantity(1, 1)">+</button>
                                </div>
                                <span class="item-total">₹240</span>
                            </div>
                        </div>
                        <button class="remove-item" onclick="removeItem(1)">×</button>
                    </div>

                    <div class="cart-item">
                        <div class="item-image">
                            <img src="/media/images/product2.jpg" alt="Fresh Bananas" onerror="this.style.background='#f0f0f0'; this.innerHTML='IMG';">
                        </div>
                        <div class="item-details">
                            <h4 class="item-name">Organic Bananas</h4>
                            <p class="item-description">Fresh organic bananas - 1 dozen</p>
                            <div class="item-price-quantity">
                                <span class="item-price">₹60</span>
                                <div class="quantity-controls">
                                    <button class="qty-btn" onclick="updateQuantity(2, -1)">-</button>
                                    <span class="quantity" id="qty-2">1</span>
                                    <button class="qty-btn" onclick="updateQuantity(2, 1)">+</button>
                                </div>
                                <span class="item-total">₹60</span>
                            </div>
                        </div>
                        <button class="remove-item" onclick="removeItem(2)">×</button>
                    </div>

                    <div class="cart-item">
                        <div class="item-image">
                            <img src="/media/images/product3.jpg" alt="Milk" onerror="this.style.background='#f0f0f0'; this.innerHTML='IMG';">
                        </div>
                        <div class="item-details">
                            <h4 class="item-name">Fresh Milk</h4>
                            <p class="item-description">Farm fresh whole milk - 1L</p>
                            <div class="item-price-quantity">
                                <span class="item-price">₹55</span>
                                <div class="quantity-controls">
                                    <button class="qty-btn" onclick="updateQuantity(3, -1)">-</button>
                                    <span class="quantity" id="qty-3">2</span>
                                    <button class="qty-btn" onclick="updateQuantity(3, 1)">+</button>
                                </div>
                                <span class="item-total">₹110</span>
                            </div>
                        </div>
                        <button class="remove-item" onclick="removeItem(3)">×</button>
                    </div>
                </div>

                <div class="cart-subtotal">
                    <div class="subtotal-line">
                        <span>Subtotal (<span id="total-items">5</span> items)</span>
                        <span class="subtotal-amount" id="subtotal-amount">₹410</span>
                    </div>
                </div>
            </div>
      <h2>Delivery Address</h2>
      <ul class="existing-addresses">
        <li>
          <h3>Select Existing Address</h3>
          <ul class="address-options">
            {% for address in addresses %}
            <li class="address-card">
              <input type="radio" name="address" id="address-{{ address.uuid }}" value="{{ address.uuid }}" {% if address.uuid|stringformat:"s" == selected_address_uuid|stringformat:"s" %}checked{% endif %} />
              <label for="address-{{ address.uuid }}" class="address-label">
                <div class="address-nickname">{{ address.address_type|upper }}</div>
                <div class="address-details">
                  <strong>{{ address.first_name }} {{ address.last_name }}</strong><br />
                  +91 {{ address.mobile }}<br />
                  {{ address.address }}<br />
                  {{ address.city }} {{ address.state }} - {{ address.zip_code }}
                </div>

                <div class="cart-subtotal">
                    <div class="subtotal-line">
                        <span>Subtotal (<span id="total-items">5</span> items)</span>
                        <span class="subtotal-amount" id="subtotal-amount">₹410</span>
                    </div>
                </div>
            </div>

            <h2>Delivery Address</h2>

            <!-- Existing Addresses Section -->
            <div class="existing-addresses">
                <h3>Select Existing Address</h3>
                <div class="address-options">
                    <div class="address-card">
                        <input type="radio" name="address" id="home-address" />
                        <label for="home-address" class="address-label">
                            <div class="address-nickname">HOME</div>
                            <div class="address-details">
                                <strong>John Doe</strong><br>
                                +91 9876543210<br>
                                123, ABC Apartment<br>
                                100 Feet Road, Koramangala<br>
                                Bangalore - 560095
                            </div>
                        </label>
                    </div>

                    <div class="address-card">
                        <input type="radio" name="address" id="office-address" />
                        <label for="office-address" class="address-label">
                            <div class="address-nickname">OFFICE</div>
                            <div class="address-details">
                                <strong>John Doe</strong><br>
                                +91 9876543210<br>
                                456, Tech Park<br>
                                Outer Ring Road, Marathahalli<br>
                                Bangalore - 560037
                            </div>
                        </label>
                    </div>
                </div>

                <button class="add-new-address-btn" onclick="toggleAddressForm()">
                    + Add New Address
                </button>
            </div>

            <!-- Add New Address Form -->
            <div class="add-address-form" id="add-address-form" style="display: none;">
                <h3>Add New Address</h3>
                <div class="delivery-details">
                    <div class="flex-row">
                        <div class="flex-col">
                            <label>First Name</label>
                            <input type="text" placeholder="Enter first name" />
                        </div>
                        <div class="flex-col">
                            <label>Last Name</label>
                            <input type="text" placeholder="Enter last name" />
                        </div>
                        <div class="flex-col">
                            <label>Contact Number</label>
                            <input type="text" placeholder="Enter contact number" />
                        </div>
                    </div>

                    <div class="flex-row">
                        <div class="flex-col">
                            <label>House No</label>
                            <input type="text" />
                        </div>
                        <div class="flex-col">
                            <label>Apartment Name</label>
                            <input type="text" />
                        </div>
                    </div>

                    <div class="flex-row">
                        <div class="flex-col">
                            <label>Street Details</label>
                            <input type="text" />
                        </div>
                        <div class="flex-col">
                            <label>Landmark</label>
                            <input type="text" />
                        </div>
                    </div>

                    <div class="flex-row">
                        <div class="flex-col">
                            <label>City</label>
                            <select>
                                <option>Bangalore</option>
                            </select>
                        </div>
                        <div class="flex-col">
                            <label>Area</label>
                            <input type="text" placeholder="Enter area" />
                        </div>
                        <div class="flex-col">
                            <label>Pincode</label>
                            <input type="text" placeholder="Enter pincode" />
                        </div>
                    </div>

                    <label>Choose nick name for this address:</label>
                    <div class="nickname-buttons">
                        <button type="button" class="nickname-btn active" onclick="selectNickname(this)">HOME</button>
                        <button type="button" class="nickname-btn" onclick="selectNickname(this)">OFFICE</button>
                        <button type="button" class="nickname-btn" onclick="selectNickname(this)">OTHER</button>
                    </div>

                    <div class="form-buttons">
                        <button type="button" class="btn cancel-btn" onclick="toggleAddressForm()">CANCEL</button>
                        <button type="button" class="btn save-btn">SAVE ADDRESS</button>
                    </div>
                </div>
            </div>

            <!-- Delivery Options -->
            <div class="collapsible">
                <div class="dropdown" onclick="toggleDropdown('delivery-options')">
                    <strong>Delivery Options</strong>
                </div>

                <div class="delivery-options-container">
                    <div class="delivery-option">
                        <input type="radio" name="delivery" id="standard-delivery" value="0" onchange="updateDeliveryCharge(0)" checked />
                        <label for="standard-delivery" class="delivery-label">
                            <div class="delivery-header">
                                <div class="delivery-icon">📦</div>
                                <div class="delivery-info">
                                    <h4>Standard Delivery</h4>
                                    <p class="delivery-time">3-5 Business Days</p>
                                </div>
                                <div class="delivery-price">FREE</div>
                            </div>
                            <div class="delivery-description">
                                Get your order delivered at standard speed with no extra cost
                            </div>
                        </label>
                    </div>

                    <div class="delivery-option">
                        <input type="radio" name="delivery" id="express-delivery" value="50" onchange="updateDeliveryCharge(50)" />
                        <label for="express-delivery" class="delivery-label">
                            <div class="delivery-header">
                                <div class="delivery-icon">⚡</div>
                                <div class="delivery-info">
                                    <h4>Express Delivery</h4>
                                    <p class="delivery-time">1-2 Business Days</p>
                                </div>
                                <div class="delivery-price">₹50</div>
                            </div>
                            <div class="delivery-description">
                                Faster delivery for when you need your items quickly
                            </div>
                        </label>
                    </div>

                    <div class="delivery-option">
                        <input type="radio" name="delivery" id="same-day-delivery" value="100" onchange="updateDeliveryCharge(100)" />
                        <label for="same-day-delivery" class="delivery-label">
                            <div class="delivery-header">
                                <div class="delivery-icon">🚀</div>
                                <div class="delivery-info">
                                    <h4>Same Day Delivery</h4>
                                    <p class="delivery-time">Within 6 Hours</p>
                                </div>
                                <div class="delivery-price">₹100</div>
                            </div>
                            <div class="delivery-description">
                                Ultra-fast delivery for urgent orders (Order before 2 PM)
                            </div>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Summary -->
        <div class="summary-wrapper">
            <div class="summary-section">
                <h3>Order Summary</h3>

                <div class="voucher-box">
                    <input type="text" placeholder="Enter voucher code" />
                    <button class="btn apply-btn">APPLY</button>
                    <p><a href="#">You have 8 vouchers available</a></p>
                </div>

                <div class="summary-line">
                    <span>Basket Value</span>
                    <span id="basket-value">Rs 410</span>
                </div>

                <div class="summary-line">
                    <span>Delivery Charge</span>
                    <span>Rs 50</span>
                </div>

                <div class="summary-line">
                    <span>Voucher Discount</span>
                    <a href="#">Apply Voucher</a>
                </div>

                <div class="summary-line total">
                    <span>Total Amount Payable</span>
                    <span id="total-payable">Rs 460</span>
                </div>

                <p class="savings">Your Total Savings Rs 22.50</p>

                <button class="checkout-btn">PROCEED TO CHECKOUT</button>
            </div>
        </div>
    </div>
</main>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
  var options = {
    "key": "rzp_test_171e6d7TSvS6aZ",
    "amount": "{{payment.amount }}",
    "currency": "INR",
    "name": "GoGroc",
    "description": "Purchase Transaction",
    "order_id": "{{payment.id}}",
    "handler": function (response) {
      const selectedAddress = document.querySelector('input[name="address"]:checked');
      const address_id = selectedAddress ? selectedAddress.value : null;

      if (!address_id) {
        alert("Please select a delivery address.");
        return;
      }

      fetch("http://127.0.0.1:8000/store/success/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie('csrftoken')
        },
        body: JSON.stringify({
          razorpay_order_id: response.razorpay_order_id,
          razorpay_payment_id: response.razorpay_payment_id,
          razorpay_signature: response.razorpay_signature,
          address_id: address_id
        })
      })
        .then(res => res.json())
        .then(data => {
          if (data.message) {
            console.log(data.message)
            alert(data.message);
            window.location.href = "/store/orders/";
          } else {
            console.error("Error:", data);
            alert(data.error || "Unknown error occurred");
          }
        })
        .catch(err => {
          console.error("Error:", err);
          alert("Payment verification failed");
        });
    },
    "theme": {
      "color": "#3399cc"
    }
  };
  const isDevMode = false;

  var rzp1 = new Razorpay(options);
  rzp1.on('payment.failed', function (response) {
    alert("Payment failed");
    console.log(response);
  });

  document.getElementById('rzp-button1').onclick = function (e) {
    e.preventDefault();
    if (isDevMode) {
    // Simulate successful payment response
    const dummyResponse = {
      razorpay_order_id: "order_dummy123",
      razorpay_payment_id: "payment_dummy123",
      razorpay_signature: "signature_dummy123"
    };

    options.handler(dummyResponse);
  } else {
    rzp1.open();
  }
  }

  // Get CSRF token from cookies
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>
<script>
 // Cart functionality
    let cartData = {
        1: { name: "Fresh Red Apples", price: 120, quantity: 2, total: 240 },
        2: { name: "Organic Bananas", price: 60, quantity: 1, total: 60 },
        3: { name: "Fresh Milk", price: 55, quantity: 2, total: 110 }
    };

    function updateQuantity(itemId, change) {
        const item = cartData[itemId];
        if (item) {
            item.quantity += change;
            if (item.quantity < 1) {
                item.quantity = 1;
            }
            item.total = item.price * item.quantity;
            
            // Update UI
            document.getElementById(`qty-${itemId}`).textContent = item.quantity;
            document.querySelector(`#qty-${itemId}`).parentElement.parentElement.querySelector('.item-total').textContent = `₹${item.total}`;
            
            updateCartSummary();
        }
    }

    function removeItem(itemId) {
        if (confirm('Are you sure you want to remove this item?')) {
            delete cartData[itemId];
            document.querySelector(`#qty-${itemId}`).closest('.cart-item').remove();
            updateCartSummary();
        }
    }

    function updateCartSummary() {
        let subtotal = 0;
        let totalItems = 0;
        
        Object.values(cartData).forEach(item => {
            subtotal += item.total;
            totalItems += item.quantity;
        });
        
        // Update subtotal in cart section
        document.getElementById('subtotal-amount').textContent = `₹${subtotal}`;
        document.getElementById('total-items').textContent = totalItems;
        
        // Update basket value in summary
        document.getElementById('basket-value').textContent = `Rs ${subtotal}`;
        
        // Update total payable (subtotal + delivery charge)
        const deliveryCharge = 50;
        const totalPayable = subtotal + deliveryCharge;
        document.getElementById('total-payable').textContent = `Rs ${totalPayable}`;
    }

    function toggleDropdown(id) {
        const options = document.getElementById(id);
        options.classList.toggle('show');
    }

    function toggleAddressForm() {
        const form = document.getElementById('add-address-form');
        const isVisible = form.style.display !== 'none';
        form.style.display = isVisible ? 'none' : 'block';
    }

    function selectNickname(button) {
        // Remove active class from all nickname buttons
        const buttons = document.querySelectorAll('.nickname-btn');
        buttons.forEach(btn => btn.classList.remove('active'));

        // Add active class to clicked button
        button.classList.add('active');
    }
</script>

<script>
  function highlightSelectedAddress() {
    const inputs = document.querySelectorAll('input[name="address"]');
    inputs.forEach((input) => {
      input.addEventListener('change', () => {
        document.querySelectorAll('.address-card').forEach((card) => {
          card.classList.remove('selected');
        });

        const selectedCard = input.closest('.address-card');
        if (selectedCard) {
          selectedCard.classList.add('selected');
        }
      });
    });

    // Initial highlight on page load
    const preselected = document.querySelector('input[name="address"]:checked');
    if (preselected) {
      const selectedCard = preselected.closest('.address-card');
      if (selectedCard) {
        selectedCard.classList.add('selected');
      }
    }
  }

  document.addEventListener('DOMContentLoaded', highlightSelectedAddress);
</script>

{% endblock main %}